<mat-card class="data-card" style="max-height: 85%;">
  <div class="table-status-container">
    <h2 class="page-title">üçΩÔ∏è Table Status</h2>

    <div class="tables">
      <mat-card *ngFor="let table of tables" [ngClass]="{
          occupied: table.status === 'occupied',
          free: table.status === 'free'
        }" class="table-card">
        <mat-card-header>
          <mat-card-title>
            {{ table.tableName || table?.tableNumber }}
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <p *ngIf="table.status === 'occupied'" class="current-bill">
            üí∞ Current Bill: <strong>‚Çπ{{ table.currentBill | number:'1.2-2' }}</strong>
          </p>

          <!-- Discount Section -->
          <div *ngIf="table.status === 'occupied'" class="discount-section">
            <div class="discount-type">
              <label>Discount Type:</label>
              <mat-button-toggle-group [(ngModel)]="tableDiscounts[table.tableId].discountType" appearance="legacy">
                <mat-button-toggle value="percentage">%</mat-button-toggle>
                <mat-button-toggle value="amount">‚Çπ</mat-button-toggle>
              </mat-button-toggle-group>
            </div>

            <div class="discount-value">
              <label>Discount Value:</label>
              <input type="number" [(ngModel)]="tableDiscounts[table.tableId].discountValue" min="0"
                class="form-control" placeholder="Enter value" />
            </div>
          </div>

          <!-- Bill Breakdown -->
          <ng-container *ngIf="table.status === 'occupied' && getBillBreakdown(table.currentBill, table.tableId) as b">
            <div class="bill-breakdown">
              <p *ngIf="taxstatus">üßæ SGST ({{ sgst }}%): ‚Çπ{{ b.sgstAmount.toFixed(2) }}</p>
              <p *ngIf="taxstatus">üßæ CGST ({{ cgst }}%): ‚Çπ{{ b.cgstAmount.toFixed(2) }}</p>
              <p *ngIf="taxstatus"><strong>Total Tax:</strong> ‚Çπ{{ b.taxTotal.toFixed(2) }}</p>

              <p *ngIf="b.discountAmount > 0" class="discount-line">
                üí∏ Discount:
                <span *ngIf="tableDiscounts[table.tableId]?.discountType === 'percentage'">
                  {{ tableDiscounts[table.tableId].discountValue }}% = ‚Çπ{{ b.discountAmount.toFixed(2) }}
                </span>
                <span *ngIf="tableDiscounts[table.tableId]?.discountType === 'amount'">
                  ‚Çπ{{ b.discountAmount.toFixed(2) }}
                </span>
              </p>

              <p><strong>Total after Discount:</strong> ‚Çπ{{ b.discountedAmount.toFixed(2) }}</p>
              <p *ngIf="b.roundOff !== 0"><strong>Round Off:</strong> ‚Çπ{{ b.roundOff.toFixed(2) }}</p>
              <p class="final-total"><strong>Total Payable:</strong> ‚Çπ{{ b.finalTotal.toFixed(2) }}</p>
            </div>
          </ng-container>
        </mat-card-content>

        <mat-card-actions *ngIf="table.status === 'occupied'" class="card-actions">
          <button style="width: 100%;" class="btn btn-primary" (click)="markAsCompleted(table.orderIds, table.tableId)"
            [disabled]="tableLoading[table.tableId]">
            <span *ngIf="tableLoading[table.tableId]">
              <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            </span>
            <span *ngIf="!tableLoading[table.tableId]">
              <i class="fa fa-check"></i> Mark as Completed
            </span>
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</mat-card>