<mat-card class="data-card">
  <div class="table-status-container">
    <h2 style="text-align: center;">Table Status</h2>
    <div class="tables">
      <mat-card *ngFor="let table of tables"
                [ngClass]="{'occupied': table.status === 'occupied', 'free': table.status === 'free'}"
                class="table-card">
        <mat-card-header>
          <mat-card-title>{{ table.tableName || table?.tableNumber }}</mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <p *ngIf="table.status === 'occupied'">
            Current Bill: ₹{{ table.currentBill | number:'1.2-2' }}
          </p>

          <!-- ✅ Discount Input -->
          <div *ngIf="table.status === 'occupied'" style="margin-bottom: 10px;">
            <label>Discount Type:</label>
            <mat-button-toggle-group
              [(ngModel)]="tableDiscounts[table.tableId].discountType"
              appearance="legacy"
              style="margin: 5px 0;">
              <mat-button-toggle value="percentage">%</mat-button-toggle>
              <mat-button-toggle value="amount">₹</mat-button-toggle>
            </mat-button-toggle-group>

            <div style="margin-top: 5px;">
              <label>Discount Value:</label>
              <input type="number"
                     [(ngModel)]="tableDiscounts[table.tableId].discountValue"
                     min="0"
                     class="form-control"
                     style="width: 100px;" />
            </div>
          </div>

          <!-- ✅ Bill Breakdown -->
          <ng-container *ngIf="table.status === 'occupied' && getBillBreakdown(table.currentBill, table.tableId) as b">
            <p *ngIf="taxstatus">SGST ({{ sgst }}%): ₹{{ b.sgstAmount.toFixed(2) }}</p>
            <p *ngIf="taxstatus">CGST ({{ cgst }}%): ₹{{ b.cgstAmount.toFixed(2) }}</p>
            <p *ngIf="taxstatus"><strong>Tax Total:</strong> ₹{{ b.taxTotal.toFixed(2) }}</p>

            <p *ngIf="b.discountAmount > 0">
              Discount:
              <span *ngIf="tableDiscounts[table.tableId]?.discountType === 'percentage'">
                {{ tableDiscounts[table.tableId].discountValue }}% = ₹{{ b.discountAmount.toFixed(2) }}
              </span>
              <span *ngIf="tableDiscounts[table.tableId]?.discountType === 'amount'">
                ₹{{ b.discountAmount.toFixed(2) }}
              </span>
            </p>

            <p><strong>Total after Discount:</strong> ₹{{ b.discountedAmount.toFixed(2) }}</p>
            <p *ngIf="b.roundOff !== 0"><strong>Round Off:</strong> ₹{{ b.roundOff.toFixed(2) }}</p>
            <p><strong>Total Payable:</strong> ₹{{ b.finalTotal.toFixed(2) }}</p>
          </ng-container>
        </mat-card-content>

        <mat-card-actions *ngIf="table.status === 'occupied'">
          <button class="btn btn-sm btn-success" style="width: 100%;"
                  (click)="markAsCompleted(table.orderIds, table.tableId)"
                  [disabled]="tableLoading[table.tableId]">
            <span *ngIf="tableLoading[table.tableId]">
              <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            </span>
            <span *ngIf="!tableLoading[table.tableId]">
              Mark as Completed <i class="fa fa-check" aria-hidden="true"></i>
            </span>
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</mat-card>
